# PRD: 사전 승인 사용자 인증 시스템

## 1. 개요

### 1.1 목적
- 처음 로그인하는 사용자에 대해 사전 승인된 사용자 명단과 대조하여 승인된 사용자만 회원가입을 허용
- 무분별한 회원가입을 방지하고 사전 승인된 사용자만 서비스를 이용할 수 있도록 제한

### 1.2 배경
- 현재 시스템은 구글 로그인만으로 누구나 회원가입이 가능
- 특정 사용자 전용 플랫폼으로 운영하기 위해 사전 승인 인증 절차 필요
- 관리자가 사전에 승인된 사용자 명단(이름, 전화번호)을 등록하고, 이를 기반으로 인증 수행

### 1.3 범위
- **포함**: 사전 승인 사용자 테이블 생성, 인증 모달, 인증 로직, 로그인 플로우 수정, 관리자 대시보드 명단 관리 UI
- **제외**: 없음 (모든 기능 포함)

---

## 2. 요구사항

### 2.1 기능 요구사항

#### 2.1.1 사전 승인 사용자 테이블 (approved_users)
- **필드 구성**:
  - `id`: UUID, Primary Key
  - `name`: VARCHAR, NOT NULL (사용자 이름)
  - `phone`: VARCHAR, NOT NULL (전화번호, 하이픈 없이 숫자만 저장)
  - `is_verified`: BOOLEAN, DEFAULT false (인증 완료 여부)
  - `user_id`: VARCHAR, NULL (users 테이블 참조, 인증 후 연결)
  - `created_at`: TIMESTAMP
  - `updated_at`: TIMESTAMP

- **제약조건**:
  - `name`과 `phone`의 조합은 UNIQUE (동명이인 구분을 위해 전화번호 포함)
  - `user_id`는 인증 완료 후 users.id와 연결 (nullable, 인증 전엔 NULL)

- **인덱스**:
  - `idx_approved_users_name_phone`: (name, phone) 조합 인덱스 (인증 조회 성능 향상)
  - `idx_approved_users_user_id`: user_id 인덱스

- **RLS (Row Level Security)**:
  - 관리자만 승인 사용자 목록 조회/생성/수정/삭제 가능
  - 일반 사용자는 자신의 인증 여부만 확인 가능 (API를 통해서만 접근)

#### 2.1.2 로그인 플로우 수정

**기존 로그인 플로우**:
```
1. 구글 로그인 버튼 클릭
2. 구글 OAuth 인증
3. users 테이블에 계정 존재 여부 확인
4. 없으면 자동 생성 → 로그인 완료
5. 있으면 → 로그인 완료
```

**새로운 로그인 플로우**:
```
1. 구글 로그인 버튼 클릭
2. 구글 OAuth 인증
3. users 테이블에 계정 존재 여부 확인
4. 계정이 있으면 → 로그인 완료
5. 계정이 없으면 → 사전 승인 인증 모달 표시
   5.1 이름, 전화번호 입력
   5.2 제출 버튼 클릭
   5.3 approved_users 테이블에서 매칭 확인
       - 매칭 실패: 에러 메시지 표시 ("등록되지 않은 사용자입니다")
       - 이미 인증됨 (is_verified=true): 에러 메시지 ("이미 인증된 전화번호입니다")
       - 매칭 성공 & 미인증:
         a. users 테이블에 새 계정 생성 (구글 정보 사용)
         b. approved_users 테이블의 해당 레코드 업데이트
            - is_verified = true
            - user_id = 새로 생성된 user.id
         c. 로그인 완료
```

#### 2.1.3 승인 사용자 인증 모달 (UserVerificationModal)

**UI 구성**:
- **제목**: "승인 사용자 인증이 필요합니다"
- **설명**: "등록된 승인 사용자만 이용 가능합니다. 등록하신 이름과 전화번호를 입력해주세요."
- **입력 필드**:
  - 이름 (name): text input, required
  - 전화번호 (phone): tel input, required, placeholder "010-1234-5678"
- **버튼**:
  - 제출: 인증 처리
  - 취소: 모달 닫기 및 로그인 취소
- **에러 메시지 표시 영역**: toast 또는 모달 내 에러 텍스트

**입력 검증**:
- 이름: 1자 이상 입력
- 전화번호: 숫자만 추출하여 10~11자리 검증 (하이픈 자동 제거)

**동작**:
1. 모달이 열리면 구글 인증 정보는 이미 받은 상태
2. 사용자가 이름, 전화번호 입력 후 제출
3. API 호출: `verifyStudent(name, phone, googleUser)`
4. 성공 시:
   - users 테이블에 계정 생성
   - approved_users 테이블 업데이트 (is_verified=true, user_id 연결)
   - 로그인 완료 처리
   - 모달 닫기
5. 실패 시:
   - 에러 메시지 표시 (모달은 유지)
   - 재시도 가능

#### 2.1.4 API 함수

**`verifyApprovedUser(name: string, phone: string, googleUser: GoogleUser)`**:
- 전화번호 정규화 (숫자만 추출)
- approved_users 테이블에서 name, phone 매칭 조회
- 매칭 실패: throw error "등록되지 않은 승인 사용자입니다"
- is_verified=true: throw error "이미 인증된 전화번호입니다"
- 매칭 성공 & is_verified=false:
  - users 테이블에 신규 계정 생성 (googleUser 정보 사용)
  - approved_users 테이블 업데이트 (is_verified=true, user_id 설정)
  - 생성된 user 객체 반환

**`checkApprovedUserVerification(userId: string)`** (선택 사항):
- 특정 user_id가 승인 사용자 인증을 거쳤는지 확인
- approved_users 테이블에서 user_id 조회
- 존재 여부 반환

#### 2.1.5 관리자 대시보드 사전 승인 사용자 명단 관리 UI

**위치**: `/admin` 페이지 내 새로운 탭 또는 섹션 추가

**기능 목록**:

1. **승인 사용자 목록 조회**:
   - approved_users 테이블 전체 데이터 표시
   - 테이블 형식: 이름, 전화번호, 인증 여부, 연결된 사용자, 등록일
   - 페이지네이션 (30개씩 표시)
   - 검색 기능 (이름, 전화번호로 필터링)
   - 인증 상태 필터 (전체/인증 완료/미인증)

2. **승인 사용자 개별 추가**:
   - 모달 또는 폼: 이름, 전화번호 입력
   - 중복 체크 (동일한 name+phone 조합 확인)
   - 저장 버튼: approved_users 테이블에 INSERT

3. **대량 등록 (스프레드시트 스타일 입력)**:
   - "대량 등록" 버튼 클릭 시 모달 표시
   - **표 형태 UI 제공**:
     - 이름 | 전화번호 컬럼으로 구성된 빈 표 (기본 100행)
     - 엑셀/구글시트에서 복사 → 표에 붙여넣기 가능 (Ctrl+V / Cmd+V)
     - 각 셀 개별 편집 가능
     - 행 추가/삭제 버튼
   - **자동 검증**:
     - 붙여넣기 또는 입력 즉시 실시간 검증
     - 이름, 전화번호 필수 값 확인
     - 전화번호 형식 검증 (10~11자리 숫자, 하이픈 자동 제거)
     - 중복 데이터 확인 (기존 데이터 및 입력된 행 간 중복)
     - 오류가 있는 셀은 빨간색 테두리 표시 + 툴팁으로 오류 메시지
   - **미리보기 및 통계**:
     - 총 입력된 행 수, 정상 행 수, 오류 행 수 표시
     - 오류만 필터링해서 볼 수 있는 토글
   - **저장**:
     - "저장" 버튼: 정상 데이터만 일괄 INSERT (트랜잭션 처리)
     - 진행률 표시: 업로드 중 프로그레스 바
     - 저장 완료 후 결과 요약 (성공 X명, 실패 Y명)

4. **승인 사용자 정보 수정**:
   - 테이블 각 행에 "수정" 버튼
   - 모달: 이름, 전화번호 수정 가능
   - is_verified=true인 경우 경고 메시지 표시
   - 저장 버튼: approved_users 테이블 UPDATE

5. **승인 사용자 삭제**:
   - 테이블 각 행에 "삭제" 버튼
   - 확인 다이얼로그 표시
   - is_verified=true인 경우 강화된 확인 (이미 인증된 사용자 삭제 시 user_id 연결 해제)
   - 삭제 버튼: approved_users 테이블 DELETE

6. **통계 대시보드**:
   - 전체 승인 사용자 수
   - 인증 완료 승인 사용자 수
   - 미인증 승인 사용자 수

**UI 레이아웃**:
```
[관리자 대시보드]
- 기존 탭: 통계, 게시글 관리, 사용자 관리
- 신규 탭: **사전 승인 사용자 관리**

[사전 승인 사용자 관리 탭]
┌─────────────────────────────────────────────┐
│ 📊 통계                                      │
│ 전체: 120명 | 인증완료: 85명 | 미인증: 35명  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ ➕ 승인 사용자 추가                                │
│ [개별 추가] [대량 등록]                      │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 🔍 검색: [_________] | 상태: [전체 ▼]        │
├─────────────────────────────────────────────┤
│ 이름    | 전화번호      | 인증여부 | 연결계정 | 등록일 | 액션 │
├─────────────────────────────────────────────┤
│ 홍길동  | 010-1234-5678 | ✅      | hong@..  | 2025-01-20 | [수정] [삭제] │
│ 김철수  | 010-9876-5432 | ❌      | -        | 2025-01-21 | [수정] [삭제] │
│ ...                                          │
└─────────────────────────────────────────────┘

[< 이전] 페이지 1 / 4 [다음 >]
```

**대량 등록 모달 상세**:
```
[대량 등록 - 스프레드시트 스타일]
┌─────────────────────────────────────────────────┐
│ 💡 엑셀이나 구글 시트에서 복사해서 붙여넣으세요  │
│                                                  │
│ 통계: 총 120행 | ✅ 정상 117명 | ⚠️ 오류 3명     │
│ [오류만 보기 ☐]  [행 추가] [전체 삭제]           │
│                                                  │
│ ┌────────────────────────────────────────────┐  │
│ │ #  | 이름      | 전화번호         | 상태   │  │
│ ├────────────────────────────────────────────┤  │
│ │ 1  | [홍길동  ] | [01012345678  ] | ✅     │  │
│ │ 2  | [김철수  ] | [01098765432  ] | ✅     │  │
│ │ 3  | [이영희  ] | [010111       ] | ⚠️ 형식│  │ ← 마우스 오버 시 "전화번호는 10-11자리여야 합니다"
│ │ 4  | [박민수  ] | [01055556666  ] | ✅     │  │
│ │ 5  | [        ] | [             ] |        │  │
│ │ ...                                         │  │
│ │ 100| [        ] | [             ] |        │  │
│ └────────────────────────────────────────────┘  │
│                                                  │
│ ⚠️ 3개 오류 발견                                 │
│ - 3번째 행: 전화번호 형식 오류                   │
│ - 15번째 행: 이름 누락                           │
│ - 27번째 행: 중복 데이터 (홍길동-01012345678)   │
│                                                  │
│ [취소] [저장 (117명)]                            │
└─────────────────────────────────────────────────┘

사용 팁:
1. 엑셀/구글시트에서 이름, 전화번호 컬럼 선택 → Ctrl+C
2. 모달에서 첫 번째 셀 클릭 → Ctrl+V
3. 자동으로 검증 완료 후 "저장" 버튼 클릭
```

**API 함수 추가**:
- `getApprovedUsers(filters, pagination)`: 승인 사용자 목록 조회
- `addApprovedUser(name, phone)`: 개별 추가
- `updateApprovedUser(id, data)`: 수정
- `deleteApprovedUser(id)`: 삭제
- `bulkInsertApprovedUsers(approvedUsers[])`: 대량 등록 (배열로 한 번에 삽입)
- `validateApprovedUserData(approvedUsers[])`: 대량 등록 전 검증 (중복 체크 포함)
- `getApprovedUserStats()`: 통계 데이터 조회

### 2.2 비기능 요구사항

#### 2.2.1 보안
- approved_users 테이블은 RLS로 보호 (관리자만 직접 접근)
- 전화번호는 암호화 없이 저장 (내부 인증용)
- 인증 API는 rate limiting 적용 (brute force 방지)

#### 2.2.2 성능
- name, phone 조합 인덱스로 빠른 조회 보장
- 인증 프로세스는 2초 이내 완료

#### 2.2.3 사용성
- 전화번호 입력 시 하이픈 자동 제거 (사용자 편의)
- 명확한 에러 메시지 제공

---

## 3. 데이터베이스 설계

### 3.1 approved_users 테이블 스키마

```sql
CREATE TABLE IF NOT EXISTS approved_users (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR NOT NULL,
  phone VARCHAR NOT NULL,
  is_verified BOOLEAN DEFAULT false,
  user_id VARCHAR REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(name, phone)
);

CREATE INDEX idx_approved_users_name_phone ON approved_users(name, phone);
CREATE INDEX idx_approved_users_user_id ON approved_users(user_id);
CREATE INDEX idx_approved_users_is_verified ON approved_users(is_verified);
```

### 3.2 RLS 정책

```sql
ALTER TABLE approved_users ENABLE ROW LEVEL SECURITY;

-- 관리자만 모든 작업 가능
CREATE POLICY "Only admins can manage approved_users" ON approved_users
  FOR ALL USING (
    EXISTS (SELECT 1 FROM users WHERE users.id = auth.uid()::text AND users.role = 'admin')
  );
```

### 3.3 approved_users 테이블 업데이트 트리거

```sql
CREATE OR REPLACE FUNCTION update_approved_users_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_approved_users_updated_at
  BEFORE UPDATE ON approved_users
  FOR EACH ROW
  EXECUTE FUNCTION update_approved_users_updated_at();
```

---

## 4. 사용자 스토리

### 4.1 사전 승인 사용자 최초 로그인
**As a** 사전 승인된 사용자
**I want to** 구글 계정으로 로그인 시 이름과 전화번호로 본인 인증을 할 수 있어야 함
**So that** 인증된 사용자만 서비스를 이용할 수 있음

**Acceptance Criteria**:
- [ ] 구글 로그인 후 users 테이블에 계정이 없으면 인증 모달이 표시됨
- [ ] 모달에서 이름, 전화번호 입력 가능
- [ ] 등록된 승인 사용자 정보와 일치하면 회원가입 완료 및 로그인
- [ ] 일치하지 않으면 에러 메시지 표시
- [ ] 이미 다른 계정으로 인증된 전화번호면 에러 메시지 표시

### 4.2 미등록 사용자 로그인 시도
**As a** 미등록 사용자
**I want to** 로그인 시도 시 명확한 안내를 받아야 함
**So that** 왜 가입할 수 없는지 이해할 수 있음

**Acceptance Criteria**:
- [ ] 승인 사용자 명단에 없는 이름/전화번호 입력 시 "등록되지 않은 승인 사용자입니다" 메시지 표시
- [ ] 모달 닫기 시 로그인 프로세스가 취소됨

### 4.3 관리자 사전 승인 사용자 명단 관리
**As an** 관리자
**I want to** 관리자 대시보드에서 사전 승인 사용자 명단을 편리하게 관리할 수 있어야 함
**So that** 별도 도구 없이 웹 UI에서 사용자 추가/수정/삭제가 가능함

**Acceptance Criteria**:
- [ ] 관리자 대시보드에 "사전 승인 사용자 관리" 탭이 표시됨
- [ ] 전체 사전 승인 사용자 목록을 테이블 형태로 조회 가능
- [ ] 이름, 전화번호로 검색 가능
- [ ] 인증 여부로 필터링 가능
- [ ] 개별 사용자 추가 가능 (이름, 전화번호 입력)
- [ ] 스프레드시트 스타일 표에서 대량 등록 가능
- [ ] 엑셀/구글시트에서 복사-붙여넣기 가능
- [ ] 실시간 데이터 검증 (입력/붙여넣기 즉시)
- [ ] 오류 셀은 빨간색 테두리와 툴팁으로 표시
- [ ] 사용자 정보 수정 가능
- [ ] 사용자 삭제 가능 (확인 다이얼로그 포함)
- [ ] 통계 대시보드에서 전체/인증/미인증 사용자 수 확인 가능

### 4.4 관리자 스프레드시트 스타일 대량 등록
**As an** 관리자
**I want to** 엑셀/구글시트에서 복사한 사전 승인 사용자 명단을 표에 붙여넣어 대량 등록할 수 있어야 함
**So that** 파일 변환 없이 빠르고 직관적으로 사용자 데이터를 등록할 수 있음

**Acceptance Criteria**:
- [ ] "대량 등록" 버튼 클릭 시 스프레드시트 스타일 모달 표시
- [ ] 이름, 전화번호 컬럼으로 구성된 빈 표 제공 (100행)
- [ ] 엑셀/구글시트에서 복사한 데이터 붙여넣기 가능 (Ctrl+V)
- [ ] 각 셀 개별 수정 가능
- [ ] 행 추가/삭제 버튼 제공
- [ ] 붙여넣기 즉시 자동 검증 (이름, 전화번호 형식, 중복)
- [ ] 오류가 있는 셀은 빨간색 테두리 + 툴팁으로 오류 메시지 표시
- [ ] 통계 표시: 총 입력 행 수, 정상 행 수, 오류 행 수
- [ ] "오류만 보기" 필터 제공
- [ ] 저장 시 정상 데이터만 일괄 INSERT
- [ ] 진행률 표시
- [ ] 저장 완료 후 결과 요약 (성공/실패 건수)

---

## 5. 기술 스택

### 5.1 Backend
- Supabase PostgreSQL: approved_users 테이블 저장
- RLS: 관리자 권한 제어
- Supabase Functions (선택): rate limiting 적용 가능

### 5.2 Frontend
- React: UserVerificationModal 컴포넌트, 관리자 대시보드 컴포넌트
- TypeScript: 타입 안정성
- Supabase JS Client: API 호출
- 스프레드시트 라이브러리 (선택):
  - Option 1: React 네이티브 구현 (contenteditable div + paste 이벤트)
  - Option 2: Handsontable, AG Grid 등 (라이선스 고려)
  - 권장: React 네이티브 구현 (경량, 커스터마이징 용이)

---

## 6. 구현 단계

### Phase 1: 데이터베이스 구축
- [ ] approved_users 테이블 생성 SQL 작성 및 실행
- [ ] RLS 정책 적용
- [ ] 인덱스 생성

### Phase 2: API 개발
- [ ] TypeScript 타입 정의 (Database 타입에 approved_users 추가)
- [ ] 전화번호 정규화 유틸리티 함수 작성 (lib/phone-utils.ts)
- [ ] 승인 사용자 인증 관련 API 함수:
  - [ ] `verifyStudent()`: 로그인 시 승인 사용자 인증
- [ ] 관리자 대시보드 API 함수:
  - [ ] `getStudents()`: 승인 사용자 목록 조회 (검색, 필터, 페이지네이션)
  - [ ] `addStudent()`: 개별 추가
  - [ ] `updateStudent()`: 수정
  - [ ] `deleteStudent()`: 삭제
  - [ ] `bulkInsertStudents()`: 대량 등록 (배열로 삽입)
  - [ ] `validateStudentData()`: 대량 등록 전 검증
  - [ ] `getApprovedUserStats()`: 통계 데이터

### Phase 3: 승인 사용자 인증 모달 UI
- [ ] UserVerificationModal 컴포넌트 작성
- [ ] 이름, 전화번호 입력 폼
- [ ] 에러 메시지 표시 UI
- [ ] 로그인 플로우 통합

### Phase 4: 관리자 대시보드 UI
- [ ] admin 페이지에 "승인 사용자 관리" 탭 추가
- [ ] 승인 사용자 목록 테이블 컴포넌트 (ApprovedUserListTable)
  - [ ] 검색 기능
  - [ ] 필터 기능 (인증 여부)
  - [ ] 페이지네이션
- [ ] 개별 추가 모달 (AddApprovedUserModal)
- [ ] 대량 등록 컴포넌트 (BulkUploadApprovedUsers)
  - [ ] 스프레드시트 스타일 표 UI
  - [ ] 붙여넣기 이벤트 처리 (Ctrl+V / Cmd+V)
  - [ ] 실시간 셀 검증 (이름, 전화번호, 중복)
  - [ ] 오류 셀 하이라이트 및 툴팁
  - [ ] 행 추가/삭제 기능
  - [ ] 오류만 보기 필터
  - [ ] 통계 표시
  - [ ] 진행률 표시
- [ ] 수정 모달 (EditApprovedUserModal)
- [ ] 삭제 확인 다이얼로그
- [ ] 통계 대시보드 (ApprovedUserStats)

### Phase 5: 로그인 플로우 통합
- [ ] AuthContext 또는 로그인 로직 수정
- [ ] 구글 로그인 성공 → users 테이블 조회 → 없으면 모달 표시
- [ ] 모달 제출 → verifyStudent() 호출 → 성공 시 users 생성 및 로그인

### Phase 6: 테스트
- [ ] 승인 사용자 인증 시나리오:
  - [ ] 등록된 승인 사용자 인증 성공
  - [ ] 미등록 승인 사용자 인증 실패
  - [ ] 이미 인증된 전화번호 재사용 시도
  - [ ] 전화번호 포맷 다양한 케이스 (하이픈 유무 등)
- [ ] 관리자 대시보드 시나리오:
  - [ ] 승인 사용자 목록 조회 및 검색
  - [ ] 개별 추가 및 중복 체크
  - [ ] 스프레드시트 스타일 대량 등록:
    - [ ] 소량 데이터 붙여넣기 (5명)
    - [ ] 대량 데이터 붙여넣기 (100명 이상)
    - [ ] 오류 포함 데이터 붙여넣기 (형식 오류, 중복 등)
    - [ ] 개별 셀 수정 후 재검증
    - [ ] 오류만 보기 필터 동작
  - [ ] 승인 사용자 정보 수정
  - [ ] 승인 사용자 삭제 (미인증/인증 완료)
  - [ ] 통계 데이터 정확성

### Phase 7: 문서화
- [ ] 관리자용 승인 사용자 명단 업로드 가이드 작성
- [ ] 스프레드시트 복사-붙여넣기 사용법 가이드
- [ ] 사용자 매뉴얼 (관리자 대시보드 사용법)

---

## 7. 에러 처리

### 7.1 에러 유형
| 에러 코드 | 메시지 | 원인 |
|---------|------|------|
| `STUDENT_NOT_FOUND` | "등록되지 않은 승인 사용자입니다. 이름과 전화번호를 확인해주세요." | approved_users 테이블에 매칭되는 레코드 없음 |
| `ALREADY_VERIFIED` | "이미 인증된 전화번호입니다. 다른 계정으로 가입되었을 수 있습니다." | is_verified=true인 레코드 |
| `INVALID_PHONE` | "올바른 전화번호 형식이 아닙니다." | 전화번호 형식 검증 실패 |
| `USER_CREATION_FAILED` | "회원가입 중 오류가 발생했습니다. 다시 시도해주세요." | users 테이블 삽입 실패 |

### 7.2 에러 처리 전략
- 모든 에러는 toast 메시지로 사용자에게 표시
- 네트워크 에러는 재시도 버튼 제공
- 에러 로그는 콘솔에 기록 (디버깅용)

---

## 8. 향후 개선 사항

### 8.1 보안 강화
- 전화번호 암호화 저장 (선택)
- 인증 시도 횟수 제한 (rate limiting)
- IP 기반 접근 제한

### 8.2 사용자 경험
- 전화번호 입력 시 자동 하이픈 삽입 UI
- 인증 완료 후 환영 메시지
- 이메일/SMS 인증 추가 (2FA)

### 8.3 관리자 기능 고도화
- 승인 사용자 데이터 엑셀(XLSX) 내보내기
- 벌크 수정 기능 (선택한 여러 승인 사용자 정보 한 번에 수정)
- 승인 사용자별 활동 로그 (언제 인증했는지, 게시글 수 등)
- 인증률 및 최근 인증 현황 그래프 (일별 인증 수)

---

## 9. 성공 지표

### 9.1 정량적 지표
- 인증 프로세스 완료 시간: 평균 30초 이내
- 미등록 사용자 차단율: 100%
- 관리자 대량 등록 처리 시간: 100명 기준 10초 이내

### 9.2 정성적 지표
- 사용자 피드백: "인증 과정이 간단하다"
- 관리자 피드백: "승인 사용자 관리가 편리하다"

---

## 10. 부록

### 10.1 사전 승인 사용자 데이터 샘플 삽입 SQL

```sql
-- 샘플 사전 승인 사용자 데이터 삽입
INSERT INTO approved_users (name, phone) VALUES
  ('홍길동', '01012345678'),
  ('김철수', '01098765432'),
  ('이영희', '01011112222');
```

### 10.2 관리자 대시보드 스프레드시트 대량 등록 가이드

**방법 1: 엑셀에서 복사-붙여넣기**
1. 관리자로 로그인 후 `/admin` 페이지 접속
2. "승인 사용자 관리" 탭 클릭
3. "대량 등록" 버튼 클릭
4. 엑셀 파일에서 이름, 전화번호 컬럼 선택 후 복사 (Ctrl+C)
   ```
   이름       전화번호
   홍길동     010-1234-5678
   김철수     010-9876-5432
   이영희     010-1111-2222
   ```
5. 모달 표의 첫 번째 셀 (이름 컬럼) 클릭
6. 붙여넣기 (Ctrl+V)
7. 자동으로 검증되며 오류가 있는 셀은 빨간색 표시
8. 오류를 수정하거나 "저장" 버튼 클릭하여 정상 데이터만 등록

**방법 2: 구글 시트에서 복사-붙여넣기**
1. 구글 시트에서 이름, 전화번호 범위 선택 후 복사
2. 위와 동일한 방법으로 붙여넣기

**팁**:
- 전화번호에 하이픈이 있어도 자동으로 제거됨
- 빈 행은 자동으로 무시됨
- 중복된 데이터는 자동으로 감지되어 표시됨

### 10.3 (선택) Supabase Dashboard를 통한 직접 삽입

관리자 UI가 구현되기 전이거나 직접 SQL로 삽입하고 싶은 경우:

1. Supabase Dashboard → Table Editor → approved_users 테이블 선택
2. Import data from CSV 클릭
3. CSV 파일 형식:
```csv
name,phone
홍길동,01012345678
김철수,01098765432
이영희,01011112222
```
4. Upload 클릭

### 10.4 전화번호 정규화 함수 예시

```typescript
// lib/phone-utils.ts
export function normalizePhone(phone: string): string {
  // 숫자만 추출
  const digits = phone.replace(/\D/g, '');

  // 10~11자리 검증
  if (digits.length < 10 || digits.length > 11) {
    throw new Error('올바른 전화번호 형식이 아닙니다.');
  }

  return digits;
}
```

---

## 11. FAQ

**Q: 승인 사용자이 전화번호를 바꾸면 어떻게 하나요?**
A: 관리자가 approved_users 테이블에서 해당 승인 사용자의 전화번호를 직접 업데이트해야 합니다. 향후 관리자 UI에서 수정 기능 제공 예정입니다.

**Q: 한 사람이 여러 계정을 만들 수 있나요?**
A: 아니요. is_verified=true가 되면 해당 전화번호는 재사용할 수 없습니다. 한 전화번호는 하나의 계정만 인증 가능합니다.

**Q: 동명이인은 어떻게 구분하나요?**
A: 이름과 전화번호의 조합으로 구분합니다. (name, phone) UNIQUE 제약조건이 있습니다.

**Q: 승인 사용자 명단은 언제 등록하나요?**
A: 서비스 오픈 전 또는 승인 사용자 모집 후 관리자가 관리자 대시보드의 CSV 업로드 기능을 통해 등록합니다. 소량의 경우 개별 추가 기능도 사용 가능합니다.

**Q: 관리자가 실수로 승인 사용자을 삭제하면 어떻게 되나요?**
A: 미인증 승인 사용자의 경우 데이터만 삭제됩니다. 이미 인증된 승인 사용자(is_verified=true)을 삭제하면 approved_users 테이블에서만 삭제되고, users 테이블의 계정은 유지됩니다 (user_id가 NULL로 설정되어 연결만 해제됨).

**Q: 스프레드시트에서 붙여넣기 시 오류가 발생하면 어떻게 되나요?**
A: 붙여넣기 즉시 자동으로 검증되며, 오류가 있는 셀은 빨간색 테두리와 툴팁으로 표시됩니다. 해당 셀을 클릭하여 직접 수정하거나, 오류를 제외한 정상 데이터만 선택적으로 저장할 수 있습니다.

**Q: 엑셀에서 헤더(컬럼명)도 같이 복사하면 어떻게 되나요?**
A: 첫 번째 행이 "이름", "전화번호" 등의 텍스트인 경우 자동으로 헤더로 인식하고 제외합니다. 또는 수동으로 삭제할 수 있습니다.

---

**작성일**: 2025-01-27
**버전**: 1.0
**작성자**: Claude Code
